
@model IEnumerable<Horizon.Models.Product>

@{
    ViewData["Title"] = "Shop - Horizon Tactical";
}

@section HeaderMetas {
    <meta name="description" content="Duyệt qua kho sản phẩm gaming của Horizon. Đầy đủ các thiết bị console, phụ kiện tay cầm, đĩa game và mô hình nhân vật anime." />
    <link rel="canonical" href="@($"{Context.Request.Scheme}://{Context.Request.Host}/Customer/Products/Shop")" />
}

@* --- BREADCRUMB & TITLE --- *@
<div class="py-3 bg-light border-bottom mb-4">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Home</a></li>
                <li class="breadcrumb-item active fw-bold" aria-current="page">Shop</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-0">Tactical Equipment</h2>
    </div>
</div>

<div class="container">
    <div class="row">
        @* --- SIDEBAR: FILTERS (Cột trái) --- *@
        <aside class="col-lg-3 mb-4">
            <div class="filter-sidebar sticky-top" style="top: 100px;">
                <form asp-action="Shop" method="get">
                    @* Search *@
                    <div class="mb-4">
                        <h6 class="filter-title">Search Gear</h6>
                        <div class="input-group border rounded">
                            <input type="text" name="searchString" class="form-control border-0 bg-transparent"
                                   value="@ViewData["CurrentSearchString"]" placeholder="e.g. HK416...">
                            <button class="btn border-0 text-muted" type="submit"><i class="bi bi-search"></i></button>
                        </div>
                    </div>

                    @* Categories *@
                    <div class="mb-4">
                        <h6 class="filter-title">Categories</h6>
                        <div class="list-group list-group-flush small">
                            @* Logic: Nếu View đang có ViewBag.ProductCategory *@
                            <select name="productCategory" class="form-select border-0 bg-light" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                @foreach (var item in (SelectList)ViewBag.ProductCategory)
                                {
                                    if (item.Value == (string)ViewData["CurrentCategory"])
                                    {
                                        <option value="@item.Value" selected>@item.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    @* Price Range *@
                    <div class="mb-4">
                        <h6 class="filter-title">Price Range</h6>
                        <div class="d-flex align-items-center gap-2">
                            @* Thêm thuộc tính value để giữ giá trị *@
                            <input type="number" name="minPrice" class="form-control form-control-sm"
                                   value="@ViewData["MinPrice"]" placeholder="Min">
                            <span class="text-muted">-</span>
                            <input type="number" name="maxPrice" class="form-control form-control-sm"
                                   value="@ViewData["MaxPrice"]" placeholder="Max">
                        </div>
                    </div>

                    @* Action Buttons *@
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">Apply Filters</button>
                        <a asp-action="Shop" class="btn btn-outline-secondary btn-sm">Clear All</a>
                    </div>
                </form>

                @* Banner phụ hoặc thông tin hỗ trợ *@
                <div class="mt-5 p-3 rounded bg-primary bg-opacity-10 border border-primary border-opacity-25 text-center">
                    <i class="bi bi-shield-check text-primary fs-3"></i>
                    <p class="small mb-0 mt-2 fw-bold text-primary">Authentic Tactical Gear</p>
                    <p class="text-muted" style="font-size: 0.7rem;">Certified supplies for high-stakes missions.</p>
                </div>
            </div>
        </aside>

        @* --- MAIN CONTENT (Cột phải) --- *@
        <main class="col-lg-9">
            @* Top Bar: Result Count & Sorting *@
            <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border">
                <p class="mb-0 text-muted small">
                    Showing <span class="text-dark fw-bold">@(Model?.Count() ?? 0)</span> tactical items
                </p>
                <div class="d-flex align-items-center gap-2">
                    <span class="small text-muted d-none d-md-block">Sort by:</span>
                    <select class="form-select form-select-sm border-0 bg-light"
                            style="width: auto;"
                            onchange="updateSortOrder(this.value)">
                        <option value="newest" selected="@(ViewData["CurrentSort"]?.ToString() == "newest")">Newest Arrivals</option>
                        <option value="price_asc" selected="@(ViewData["CurrentSort"]?.ToString() == "price_asc")">Price: Low to High</option>
                        <option value="price_desc" selected="@(ViewData["CurrentSort"]?.ToString() == "price_desc")">Price: High to Low</option>
                        <option value="rating" selected="@(ViewData["CurrentSort"]?.ToString() == "rating")">Top Rated</option>
                    </select>
                </div>
            </div>

            @* Product Grid *@
            @if (Model != null && Model.Any())
            {
                <div class="row g-4">
                    @foreach (var item in Model)
                    {
                        @* 
                           Dùng Partial View. 
                           Lưu ý: Bạn cần chắc chắn col-lg-4 được set trong Partial 
                           hoặc bao bọc nó như thế này:
                        *@
                        <div class="col-lg-4 col-md-6">
                            <partial name="_ProductCardPartial" model="item" />
                        </div>
                    }
                </div>

                @* Pagination (Gợi ý nếu sau này cậu làm phân trang) *@
                <nav class="mt-5">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">Next</a></li>
                    </ul>
                </nav>
            }
            else
            {
                <div class="text-center py-5 bg-white rounded shadow-sm border">
                    <i class="bi bi-search fs-1 text-muted opacity-25"></i>
                    <p class="mt-3 text-muted">No gear found matching your current filters.</p>
                    <a asp-action="Shop" class="btn btn-primary">Browse All Products</a>
                </div>
            }
        </main>
    </div>
</div>

@section Scripts {
    <script>
        function updateSortOrder(val) {
            // 1. Tìm cái form lọc bên trái (sidebar)
            var filterForm = document.querySelector('.filter-sidebar form');

            // 2. Tạo một input ẩn chứa giá trị sort nếu chưa có
            var sortInput = filterForm.querySelector('input[name="sortOrder"]');
            if (!sortInput) {
                sortInput = document.createElement('input');
                sortInput.type = 'hidden';
                sortInput.name = 'sortOrder';
                filterForm.appendChild(sortInput);
            }

            // 3. Gán giá trị và Submit form
            sortInput.value = val;
            filterForm.submit();
        }
    </script>
}